<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ stock.name }} Report</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
    <link rel="stylesheet" href="{% static 'css/report.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div class="container">
    <div class="sidebar">
        <div class="logo-section"><div class="logo">ðŸ“ˆ</div><h2>StockRiskTracker</h2></div>
        <a href="{% url 'dashboard' %}">Dashboard</a>
        <a href="{% url 'watchlist' %}">Watchlist</a>
        <a href="{% url 'history' %}">History</a>
        <a href="#" class="active">Report</a>
    </div>

    <div class="main">
        <div class="header-top">
            <div class="header-content">
                <div class="company-logo" style="display:flex;align-items:center;justify-content:center;background:#eee;font-weight:bold;font-size:24px;">
                    {{ stock.symbol|slice:":1" }}
                </div>
                <div>
                    <h1>{{ stock.name }}</h1>
                    <span style="color:#666;">{{ stock.symbol }}</span>
                </div>
            </div>
        </div>

        <section class="report-section">
            <h2>Executive Summary</h2>
            <div class="summary-grid">
                <div class="summary-card">
                    <span>Recommendation</span>
                    <strong class="{% if stock.recommendation == 'BUY' %}safe{% else %}risky{% endif %}">
                        {{ stock.recommendation }}
                    </strong>
                </div>
                <div class="summary-card">
                    <span>Target Price</span>
                    <strong>{{ stock.currency_symbol }} {{ stock.target_price }}</strong>
                </div>
                <div class="summary-card">
                    <span>Expected Upside</span>
                    <strong class="{% if stock.upside > 0 %}safe{% else %}risky{% endif %}">
                        {{ stock.upside }}%
                    </strong>
                </div>
                <div class="summary-card">
                    <span>Market Cap</span>
                    <strong>{{ stock.market_cap }}</strong>
                </div>
            </div>
        </section>

        <section class="report-section">
            <h2>Price Action</h2>
            <div class="price-info">
                <div class="info-box">
                    <span>Current Price</span>
                    <strong style="font-size: 1.5em; color: #1f3c88;">{{ stock.currency_symbol }} {{ stock.current_price }}</strong>
                </div>
                <div class="info-box"><span>52 Week High</span><strong>{{ stock.high_52 }}</strong></div>
                <div class="info-box"><span>52 Week Low</span><strong>{{ stock.low_52 }}</strong></div>
            </div>

            <div class="chart-box" style="margin-top: 20px;">
                <canvas id="priceChart"></canvas>
            </div>
        </section>

        <section class="report-section trading-section">
            <h2>Execute Trade</h2>
            <form action="{% url 'dashboard' %}" method="POST" class="trading-form" style="display:flex; gap:10px; align-items:flex-end;">
                {% csrf_token %}
                <input type="hidden" name="ticker" value="{{ stock.symbol }}">
                
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" name="quantity" value="1" min="1" class="form-input" style="width:100px;">
                </div>

                <div class="form-group">
                    <label>Est. Cost</label>
                    <div style="padding:10px; background:#f0f0f0; border-radius:5px;">
                        {{ stock.currency_symbol }} <span id="estCost">{{ stock.current_price }}</span>
                    </div>
                </div>

                <button type="submit" class="buy-btn">BUY STOCK</button>
            </form>
        </section>

        <section class="report-section">
            <h2>Company Overview</h2>
            <p>{{ stock.summary }}</p>
        </section>
    </div>
</div>

<script>
    // 1. Get Data from Django (Passed as JSON)
    const dates = JSON.parse('{{ chart_dates|safe }}');
    const prices = JSON.parse('{{ chart_prices|safe }}');
    const currentPrice = {{ stock.current_price }};

    // 2. Render Chart
    const ctx = document.getElementById('priceChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Price History (1 Year)',
                data: prices,
                borderColor: '#1f3c88',
                backgroundColor: 'rgba(31,60,136,0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.1,
                pointRadius: 0 // Hide dots for cleaner look
            }]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: { x: { display: false } } // Hide x-axis labels for neatness
        }
    });

    // 3. Simple Cost Calculator for the Form
    const qtyInput = document.querySelector('input[name="quantity"]');
    const costDisplay = document.getElementById('estCost');

    qtyInput.addEventListener('input', function() {
        let cost = (this.value * currentPrice).toFixed(2);
        costDisplay.innerText = cost;
    });
</script>

</body>
</html>